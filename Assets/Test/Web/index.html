<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¸ãƒ£ã‚¤ãƒ­ ã‚»ãƒ³ã‚µãƒ¼é€ä¿¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }

        .status {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            font-size: 1.1em;
            padding: 12px 25px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #1976D2;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #enableGyroBtn.enabled {
            background-color: #ff9800;
        }

        #enableGyroBtn.enabled:hover {
            background-color: #f57c00;
        }

        #data {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            min-height: 150px;
            text-align: left;
            font-size: 1.1em;
            line-height: 1.8;
            margin-top: 20px;
        }

        .gyro-value {
            margin: 10px 0;
            padding: 12px;
            background-color: white;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
        }

        .gyro-label {
            font-weight: bold;
            color: #333;
            display: inline-block;
            min-width: 100px;
        }

        .gyro-number {
            color: #2196F3;
            font-size: 1.2em;
            font-weight: bold;
        }

        .gyro-unit {
            color: #666;
            font-size: 0.9em;
        }

        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        .instructions h3 {
            margin-bottom: 10px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± ã‚¸ãƒ£ã‚¤ãƒ­ ã‚»ãƒ³ã‚µãƒ¼é€ä¿¡</h1>
        
        <div class="instructions">
            <h3>ä½¿ã„æ–¹</h3>
            <ol style="text-align: left; padding-left: 20px;">
                <li>ä¸­ç¶™ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ï¼ˆNode.js server.jsï¼‰</li>
                <li>ã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: ws://192.168.x.x:8080ï¼‰</li>
                <li>ã€Œã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚’ä¸ãˆã¦ãã ã•ã„</li>
                <li>è‡ªå‹•çš„ã«ã‚¸ãƒ£ã‚¤ãƒ­ãƒ‡ãƒ¼ã‚¿ãŒã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã¾ã™</li>
            </ol>
        </div>

        <div class="input-group">
            <label for="serverUrl">ã‚µãƒ¼ãƒãƒ¼URL</label>
            <input type="text" id="serverUrl" placeholder="ws://192.168.x.x:8080 ã¾ãŸã¯ ws://localhost:8080" value="ws://localhost:8080">
        </div>

        <p id="status" class="status disconnected">ã¾ãšã€Œã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚</p>
        <button id="enableGyroBtn">ã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–</button>
        <button id="connectBtn" disabled>ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š</button>
        
        <div id="data">
            <div class="gyro-value">
                <span class="gyro-label">Alpha (Zè»¸):</span>
                <span class="gyro-number" id="alpha">---</span>
                <span class="gyro-unit">Â° (0-360)</span>
            </div>
            <div class="gyro-value">
                <span class="gyro-label">Beta (Xè»¸):</span>
                <span class="gyro-number" id="beta">---</span>
                <span class="gyro-unit">Â° (-180 to 180)</span>
            </div>
            <div class="gyro-value">
                <span class="gyro-label">Gamma (Yè»¸):</span>
                <span class="gyro-number" id="gamma">---</span>
                <span class="gyro-unit">Â° (-90 to 90)</span>
            </div>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById("status");
        const alphaEl = document.getElementById("alpha");
        const betaEl = document.getElementById("beta");
        const gammaEl = document.getElementById("gamma");
        const connectBtn = document.getElementById("connectBtn");
        const enableGyroBtn = document.getElementById("enableGyroBtn");
        const serverUrlInput = document.getElementById("serverUrl");

        let ws = null;
        let isConnected = false;
        let gyroListener = null;
        let motionListener = null;
        let gyroEnabled = false;
        let dataReceived = false;
        let lastSendTs = 0;
        const SEND_INTERVAL_MS = 50; // é€ä¿¡é »åº¦ï¼ˆ20fpsï¼‰

        // ã‚¸ãƒ£ã‚¤ãƒ­ãƒ‡ãƒ¼ã‚¿ã‚’æ•°å€¤ã§è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function updateGyroDisplay(alpha, beta, gamma) {
            alphaEl.textContent = alpha !== null && alpha !== undefined ? alpha.toFixed(2) : "---";
            betaEl.textContent = beta !== null && beta !== undefined ? beta.toFixed(2) : "---";
            gammaEl.textContent = gamma !== null && gamma !== undefined ? gamma.toFixed(2) : "---";
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ã™ã‚‹é–¢æ•°ï¼ˆãƒˆã‚°ãƒ«ï¼‰
        function toggleGyroSensor() {
            if (gyroEnabled) {
                disableGyroSensor();
            } else {
                enableGyroSensor();
            }
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹é–¢æ•°
        function enableGyroSensor() {
            if (gyroEnabled) {
                return;
            }

            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response == 'granted') {
                            startGyroListeners();
                            statusEl.innerText = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚";
                            statusEl.className = "status connected";
                            updateGyroButtonState(true);
                            connectBtn.disabled = false;
                        } else {
                            statusEl.innerText = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚";
                            statusEl.className = "status disconnected";
                            console.error("ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ");
                        }
                    })
                    .catch(error => {
                        statusEl.innerText = `ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                        statusEl.className = "status disconnected";
                        console.error("ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚¨ãƒ©ãƒ¼:", error);
                        startGyroListeners();
                        updateGyroButtonState(true);
                        connectBtn.disabled = false;
                    });
            } else {
                startGyroListeners();
                statusEl.innerText = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚";
                statusEl.className = "status connected";
                updateGyroButtonState(true);
                connectBtn.disabled = false;
            }
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹é–¢æ•°
        function disableGyroSensor() {
            if (!gyroEnabled) {
                return;
            }

            if (gyroListener) {
                window.removeEventListener("deviceorientation", gyroListener, true);
                gyroListener = null;
            }

            if (motionListener) {
                window.removeEventListener("devicemotion", motionListener, true);
                motionListener = null;
            }

            gyroEnabled = false;
            dataReceived = false;

            updateGyroDisplay(null, null, null);

            if (isConnected) {
                disconnectFromServer();
            }

            statusEl.innerText = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸã€‚";
            statusEl.className = "status disconnected";
            updateGyroButtonState(false);
            connectBtn.disabled = true;
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateGyroButtonState(enabled) {
            if (enabled) {
                enableGyroBtn.textContent = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚’ç„¡åŠ¹åŒ–";
                enableGyroBtn.classList.add("enabled");
            } else {
                enableGyroBtn.textContent = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–";
                enableGyroBtn.classList.remove("enabled");
            }
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
        function startGyroListeners() {
            if (gyroEnabled) return;

            gyroListener = (event) => {
                const alpha = event.alpha;
                const beta = event.beta;
                const gamma = event.gamma;

                if (alpha !== null && beta !== null && gamma !== null) {
                    dataReceived = true;

                    updateGyroDisplay(alpha, beta, gamma);

                    // æ¥ç¶šã—ã¦ã„ã‚‹å ´åˆã®ã¿ã‚µãƒ¼ãƒãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                    if (isConnected && ws && ws.readyState === WebSocket.OPEN) {
                        const now = Date.now();
                        if (now - lastSendTs >= SEND_INTERVAL_MS) {
                            lastSendTs = now;
                            sendGyroData(alpha, beta, gamma);
                        }
                    }
                }
            };

            motionListener = (event) => {
                if (event.rotationRate) {
                    const alpha = event.rotationRate.alpha;
                    const beta = event.rotationRate.beta;
                    const gamma = event.rotationRate.gamma;

                    if (alpha !== null || beta !== null || gamma !== null) {
                        dataReceived = true;
                    }
                }
            };

            window.addEventListener("deviceorientation", gyroListener, true);
            if (window.DeviceMotionEvent) {
                window.addEventListener("devicemotion", motionListener, true);
            }

            gyroEnabled = true;
            console.log("Gyro listeners started.");

            setTimeout(() => {
                if (!dataReceived && gyroEnabled) {
                    statusEl.innerText = "ã‚¸ãƒ£ã‚¤ãƒ­ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒã‚¤ã‚¹ã‚’å‚¾ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚";
                    statusEl.className = "status disconnected";
                }
            }, 3000);
        }

        // ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š
        function connectToServer() {
            const url = serverUrlInput.value.trim();
            if (!url) {
                statusEl.innerText = "ã‚µãƒ¼ãƒãƒ¼URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                statusEl.className = "status disconnected";
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log("Already connected to server");
                return;
            }

            try {
                statusEl.innerText = "ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...";
                statusEl.className = "status connecting";

                ws = new WebSocket(url);

                ws.onopen = () => {
                    isConnected = true;
                    statusEl.innerText = "æ¥ç¶šæˆåŠŸï¼ã‚¸ãƒ£ã‚¤ãƒ­ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­...";
                    statusEl.className = "status connected";
                    console.log("WebSocket connection opened");
                };

                ws.onmessage = (event) => {
                    console.log(`Received: ${event.data}`);
                };

                ws.onerror = (error) => {
                    statusEl.innerText = "ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                    statusEl.className = "status disconnected";
                    console.error("WebSocket error:", error);
                };

                ws.onclose = (event) => {
                    isConnected = false;
                    statusEl.innerText = "åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šã—ã¾ã™...";
                    statusEl.className = "status disconnected";
                    console.log(`WebSocket connection closed (code: ${event.code}, reason: ${event.reason || 'none'})`);
                    ws = null;

                    // è‡ªå‹•å†æ¥ç¶š
                    if (gyroEnabled) {
                        setTimeout(() => {
                            if (gyroEnabled) {
                                connectToServer();
                            }
                        }, 2000);
                    }
                };

            } catch (error) {
                statusEl.innerText = `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`;
                statusEl.className = "status disconnected";
                console.error("Connection error:", error);
            }
        }

        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­
        function disconnectFromServer() {
            if (ws) {
                ws.close();
                isConnected = false;
                statusEl.innerText = "åˆ‡æ–­ã—ã¾ã—ãŸã€‚";
                statusEl.className = "status disconnected";
                console.log("WebSocket connection closed by user");
            }
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
        function sendGyroData(alpha, beta, gamma) {
            if (!isConnected || !ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }

            try {
                const gyroData = {
                    alpha: alpha,
                    beta: beta,
                    gamma: gamma,
                    timestamp: new Date().toISOString()
                };

                const json = JSON.stringify(gyroData);
                ws.send(json);
            } catch (error) {
                console.error(`Error sending gyro data: ${error.message}`);
            }
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        enableGyroBtn.addEventListener("click", toggleGyroSensor);

        // æ¥ç¶šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        connectBtn.addEventListener("click", () => {
            if (isConnected) {
                disconnectFromServer();
            } else {
                connectToServer();
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¸ãƒ£ã‚¤ãƒ­è¡¨ç¤ºã‚’é–‹å§‹
        if (window.DeviceOrientationEvent || window.DeviceMotionEvent) {
            statusEl.innerText = "ã€Œã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚";
        } else {
            statusEl.innerText = "ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯ã‚¸ãƒ£ã‚¤ãƒ­ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“";
            statusEl.className = "status disconnected";
            enableGyroBtn.disabled = true;
            connectBtn.disabled = true;
            updateGyroDisplay(null, null, null);
        }
    </script>
</body>
</html>
