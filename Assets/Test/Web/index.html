<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¸ãƒ£ã‚¤ãƒ­ ã‚»ãƒ³ã‚µãƒ¼é€ä¿¡</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }

        .status {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
        }

        button {
            font-size: 1.1em;
            padding: 12px 25px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background-color 0.3s;
            width: 100%;
            max-width: 300px;
        }

        button:hover {
            background-color: #1976D2;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #enableGyroBtn.enabled {
            background-color: #ff9800;
        }

        #enableGyroBtn.enabled:hover {
            background-color: #f57c00;
        }

        #data {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            min-height: 150px;
            text-align: left;
            font-size: 1.1em;
            line-height: 1.8;
            margin-top: 20px;
        }

        .gyro-value {
            margin: 10px 0;
            padding: 12px;
            background-color: white;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
        }

        .gyro-label {
            font-weight: bold;
            color: #333;
            display: inline-block;
            min-width: 100px;
        }

        .gyro-number {
            color: #2196F3;
            font-size: 1.2em;
            font-weight: bold;
        }

        .gyro-unit {
            color: #666;
            font-size: 0.9em;
        }

        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        .instructions h3 {
            margin-bottom: 10px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± ã‚¸ãƒ£ã‚¤ãƒ­ ã‚»ãƒ³ã‚µãƒ¼é€ä¿¡</h1>
        
        <div class="instructions">
            <h3>ä½¿ã„æ–¹</h3>
            <ol style="text-align: left; padding-left: 20px;">
                <li>ã€Œã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚’ä¸ãˆã¦ãã ã•ã„</li>
                <li>è‡ªå‹•çš„ã«ã‚¸ãƒ£ã‚¤ãƒ­ãƒ‡ãƒ¼ã‚¿ãŒFirebase Realtime Databaseã«é€ä¿¡ã•ã‚Œã¾ã™</li>
                <li>Unityå´ã§ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¦ã‚²ãƒ¼ãƒ æ“ä½œã«åæ˜ ã•ã‚Œã¾ã™</li>
            </ol>
        </div>

        <p id="status" class="status disconnected">ã¾ãšã€Œã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚</p>
        <button id="enableGyroBtn">ã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–</button>
        
        <div id="data">
            <div class="gyro-value">
                <span class="gyro-label">Alpha (Zè»¸):</span>
                <span class="gyro-number" id="alpha">---</span>
                <span class="gyro-unit">Â° (0-360)</span>
            </div>
            <div class="gyro-value">
                <span class="gyro-label">Beta (Xè»¸):</span>
                <span class="gyro-number" id="beta">---</span>
                <span class="gyro-unit">Â° (-180 to 180)</span>
            </div>
            <div class="gyro-value">
                <span class="gyro-label">Gamma (Yè»¸):</span>
                <span class="gyro-number" id="gamma">---</span>
                <span class="gyro-unit">Â° (-90 to 90)</span>
            </div>
        </div>
    </div>

    <script>
        // Firebaseè¨­å®šï¼ˆæä¾›ã•ã‚ŒãŸæƒ…å ±ã‚’ä½¿ç”¨ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyDDbQ1fClyVJgXeYlRPr9KVmpN8Z0L-ceY",
            authDomain: "gyro-67262.firebaseapp.com",
            databaseURL: "https://gyro-67262-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gyro-67262",
            storageBucket: "gyro-67262.firebasestorage.app",
            messagingSenderId: "334654487209",
            appId: "1:334654487209:web:6bdbb65a93f107db1bc7b8",
            measurementId: "G-CXFVW3T368"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Unityã¨å…±æœ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã¸ã®å‚ç…§ã‚’å–å¾—
        const gyroRef = database.ref('gyro/data');
        // ğŸš¨ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯ { "gyro": { "data": {...} } } ã¨ã„ã†æ§‹é€ ã§ä¿å­˜ã•ã‚Œã¾ã™

        const statusEl = document.getElementById("status");
        const alphaEl = document.getElementById("alpha");
        const betaEl = document.getElementById("beta");
        const gammaEl = document.getElementById("gamma");
        const enableGyroBtn = document.getElementById("enableGyroBtn");

        let gyroListener = null;
        let motionListener = null;
        let gyroEnabled = false;
        let dataReceived = false;
        let lastSendTime = 0;
        const SEND_INTERVAL = 33; // 30 FPSç›¸å½“ (33ms) - ä½é…å»¶ã®ãŸã‚

        // ã‚¸ãƒ£ã‚¤ãƒ­ãƒ‡ãƒ¼ã‚¿ã‚’æ•°å€¤ã§è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function updateGyroDisplay(alpha, beta, gamma) {
            alphaEl.textContent = alpha !== null && alpha !== undefined ? alpha.toFixed(2) : "---";
            betaEl.textContent = beta !== null && beta !== undefined ? beta.toFixed(2) : "---";
            gammaEl.textContent = gamma !== null && gamma !== undefined ? gamma.toFixed(2) : "---";
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ã™ã‚‹é–¢æ•°ï¼ˆãƒˆã‚°ãƒ«ï¼‰
        function toggleGyroSensor() {
            if (gyroEnabled) {
                disableGyroSensor();
            } else {
                enableGyroSensor();
            }
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹é–¢æ•°
        function enableGyroSensor() {
            if (gyroEnabled) {
                return;
            }

            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ ã®å ´åˆã€æ˜ç¤ºçš„ãªè¨±å¯ãŒå¿…è¦
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response == 'granted') {
                            startGyroListeners();
                            statusEl.innerText = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼ãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã«é€ä¿¡ä¸­...";
                            statusEl.className = "status connected";
                            updateGyroButtonState(true);
                        } else {
                            statusEl.innerText = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚";
                            statusEl.className = "status disconnected";
                            console.error("ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ");
                        }
                    })
                    .catch(error => {
                        statusEl.innerText = `ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                        statusEl.className = "status disconnected";
                        console.error("ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚¨ãƒ©ãƒ¼:", error);
                        startGyroListeners();
                        updateGyroButtonState(true);
                    });
            } else {
                // é€šå¸¸ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆè¨±å¯APIãªã—ï¼‰
                startGyroListeners();
                statusEl.innerText = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã«é€ä¿¡ä¸­...";
                statusEl.className = "status connected";
                updateGyroButtonState(true);
            }
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹é–¢æ•°
        function disableGyroSensor() {
            if (!gyroEnabled) {
                return;
            }

            if (gyroListener) {
                window.removeEventListener("deviceorientation", gyroListener, true);
                gyroListener = null;
            }

            if (motionListener) {
                window.removeEventListener("devicemotion", motionListener, true);
                motionListener = null;
            }

            gyroEnabled = false;
            dataReceived = false;

            updateGyroDisplay(null, null, null);

            statusEl.innerText = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸã€‚";
            statusEl.className = "status disconnected";
            updateGyroButtonState(false);
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateGyroButtonState(enabled) {
            if (enabled) {
                enableGyroBtn.textContent = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚’ç„¡åŠ¹åŒ–";
                enableGyroBtn.classList.add("enabled");
            } else {
                enableGyroBtn.textContent = "ã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–";
                enableGyroBtn.classList.remove("enabled");
            }
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
        function startGyroListeners() {
            if (gyroEnabled) return;

            gyroListener = (event) => {
                const alpha = event.alpha;
                const beta = event.beta;
                const gamma = event.gamma;

                if (alpha !== null && beta !== null && gamma !== null) {
                    dataReceived = true;

                    // ç”»é¢ã«è¡¨ç¤º
                    updateGyroDisplay(alpha, beta, gamma);

                    // é€ä¿¡é »åº¦ã‚’åˆ¶é™ (ä½é…å»¶ã®ãŸã‚ã€é–“å¼•ãã¯é‡è¦)
                    const now = Date.now();
                    if (now - lastSendTime < SEND_INTERVAL) return;
                    lastSendTime = now;

                    // Firebase Realtime Databaseã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                    const dataToSend = {
                        alpha: parseFloat(alpha.toFixed(2)),
                        beta: parseFloat(beta.toFixed(2)),
                        gamma: parseFloat(gamma.toFixed(2)),
                        timestamp: Date.now()
                    };

                    // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›¸ãè¾¼ã‚€
                    gyroRef.set(dataToSend)
                        .then(() => {
                            // é€ä¿¡æˆåŠŸï¼ˆãƒ­ã‚°å‡ºåŠ›ã¯ä¸è¦ï¼‰
                        })
                        .catch((error) => {
                            statusEl.innerText = `ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                            statusEl.className = "status disconnected";
                            console.error("Firebaseé€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
                        });
                }
            };

            motionListener = (event) => {
                if (event.rotationRate) {
                    const alpha = event.rotationRate.alpha;
                    const beta = event.rotationRate.beta;
                    const gamma = event.rotationRate.gamma;

                    if (alpha !== null || beta !== null || gamma !== null) {
                        dataReceived = true;
                    }
                }
            };

            window.addEventListener("deviceorientation", gyroListener, true);
            if (window.DeviceMotionEvent) {
                window.addEventListener("devicemotion", motionListener, true);
            }

            gyroEnabled = true;
            console.log("Gyro listeners started. Sending data to Firebase Realtime Database...");

            // ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„å ´åˆã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            setTimeout(() => {
                if (!dataReceived && gyroEnabled) {
                    statusEl.innerText = "ã‚¸ãƒ£ã‚¤ãƒ­ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒã‚¤ã‚¹ã‚’å‚¾ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚";
                    statusEl.className = "status disconnected";
                }
            }, 3000);
        }

        // ã‚¸ãƒ£ã‚¤ãƒ­æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        enableGyroBtn.addEventListener("click", toggleGyroSensor);

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        if (window.DeviceOrientationEvent || window.DeviceMotionEvent) {
            statusEl.innerText = "ã€Œã‚¸ãƒ£ã‚¤ãƒ­ã‚’æœ‰åŠ¹åŒ–ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚";
        } else {
            statusEl.innerText = "ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯ã‚¸ãƒ£ã‚¤ãƒ­ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“";
            statusEl.className = "status disconnected";
            enableGyroBtn.disabled = true;
            updateGyroDisplay(null, null, null);
        }

        // Firebaseæ¥ç¶šçŠ¶æ…‹ã‚’ç›£è¦–
        gyroRef.onDisconnect().cancel();
    </script>
</body>
</html>

